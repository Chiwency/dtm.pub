# 架构

## 架构与角色

dtm包括服务端和客户端，整体架构图如下：

![arch](../imgs/arch.jpg)

整个分布式事务的运行过程中，一共有三个角色参与，和OPEN/X XA事务标准类似，但也会有一些区别

- RM-资源管理器：RM管理分布式事务中的本地事务，负责相关数据的修改、提交、回滚、补偿等操作。通常对应一个微服务。
- AP-应用程序：AP会注册全局事务，按照业务规则，注册子事务，调用RM接口。通常对应一个微服务。
- TM-事务管理器：每个全局事务在TM注册，每个子事务也注册到TM。TM会协调所有的RM，将同一个全局事务的不同子事务，全部提交或全部回滚。对应dtm服务实例。

## 高可用

在DTM架构下，TM由dtm服务构成，每个dtm实例都是无状态的应用程序，他们将全局事务数据存储在dtm的数据库。实际业务只要给dtm配置了高可用的数据库，那么整个dtm服务就是天然高可用的。

在简单部署模式下，一方面每个dtm都提供rest服务，接受AP的事务请求。另一方面dtm还会启动一个协程，定时查询超时需要处理的全局事务，重试之前状态不确定的事务分支。
